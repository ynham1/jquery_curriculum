<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css">
    <link rel="stylesheet" href="../../common/css/base.css">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input type="text" id="js-search-word" class="search__text__input" placeholder="検索する">
          </div>
          <button id="js-search-button" class="search__btn">検索する</button>
        </div>
        <ul class="lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script>
      // 楽天ブックスの総合検索APIを使って製作してください。
      // answerの挙動を良く見てね！
      //
      // 下記URLにAPIの仕様が載ってるいので、ブラウザで開いて参考にしてください。
      // https://webservice.rakuten.co.jp/api/bookstotalsearch/
      //
      //
      // [使うメソッド]
      // $.each(配列, function functionName() {}) 配列に対しての繰り返し処理
      // $.ajax({}) 外部ファイルやURLに対してデータをリクエストすることができます。
      // 以下は今回使う$.ajaxの基本的な形です。
      //
      // $.ajax({
      //   url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
      //   type: 'GET',
      //   datatype: 'data',
      //   data: {
      //     // 「区分:サービス固有パラメーター」を確認して、必要な情報をdata内に入れましょう。
      //     applicationId: '1019399324990976605', // (今回はこのIDを使用してください)
      //     booksGenreId: '001'
      //   },
      // }).done(function(data) {
      //   // この中にデータ取得後の動きを記述していきます。
      //   console.log(data);
      // });
      //
      //
      // $.ajaxによってデータが取得できたら、必要なデータ(作品名とか作者名とか)を取得します。
      // 取得できたらHTMLに<ul class='lists'></ul>を用意しているので、その中に下のテンプレに沿ってデータを入れ込みましょう。
      // <li class='lists__item'>
      //  <div class='lists__item__inner'>
      //    <a href='' class='lists__item__link' target='_blank'>
      //      <img src='' class='lists__item__img' alt=''>
      //      <p class='lists__item__detail'>作品名：</p>
      //      <p class='lists__item__detail'>作者　：</p>
      //      <p class='lists__item__detail'>出版社：</p>
      //    </a>
      //  </div>
      // </li>
      //
      //
      $(function(){
        var clickCount = 1;
        var prev = "";
        $('.search__btn').on('click',function(){
          movement();
        });
//----------------------------------------------------
        function movement() {
          $('.message').remove();
          var current = $('.search__text__input').val();
          if(current === prev){
            clickCount++;
          }else{
            $('.lists').empty();
            clickCount = 1;
          };
          prev = current;
          $.ajax({//非同期でサーバー間の通信を行うこと
            type: 'GET',//HTTP通信の種類を設定
            url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
            dataType: 'json',//サーバから返されるデータの型//dataはそもそも無い//JSON形式データとしてJavaScriptのオブジェクトに変換
            data:{//サーバに送信する値
              applicationId: '1019399324990976605', 
              booksGenreId: '001',
              keyword: current,
              hits: 20,
              page: clickCount
            },
          }).done(function(json){
            console.log(json);
            prependList(json);//関数prependListをdone処理の外に出しても、jsonデータが利用出来る様に引数にjsonを入力
          }).fail(function(json){
            console.log(json);
            showError(json);
          });
        };
//----------------------------------------------------
        function prependList(json){
          var list = '';
          $.each(json.Items,function(i,val){
            urlVal = val.Item.itemUrl,
            imageVal = val.Item.largeImageUrl,
            titleVal = val.Item.title,
            authorVal = val.Item.author,
            publisherVal = val.Item.publisherName;
            list += '<li class="lists__item">'+
              '<div class="lists__item__inner">'+
              '<a href="'+urlVal+'" class="lists__item__link" target="_blank">'+
              '<img src=" '+imageVal+' " class="lists__item__img" alt="'+titleVal+'">'+
              '<p class="lists__item__detail">作品名：'+titleVal+'</p>'+
              '<p class="lists__item__detail">作者　：'+authorVal+'</p>'+
              '<p class="lists__item__detail">出版社：'+publisherVal+'</p>'+
              '</a></div></li>';
          });
          $('.lists').prepend(list);//子要素の先頭に追加
          if(json.count == 0){
            $('.search').after('<div class ="message">'+
            '検索結果が見つかりませんでした。'+
            '<br>'+'別のキーワードで検索して下さい。'+
            '</div>');
          };
        };
//----------------------------------------------------
        function showError(json){
          if(json.statusText === 'error'){
            $('.search').after('<div class ="message">'+'ERR_INTERNET_DISCONNECTED'+'</div>');
          }else{
            $('.search').after('<div class ="message">'+json.responseJSON.error_description+'</div>');
          };
        };
      });
  //     $(function(){
  //       var clickCount = 1;
  //       var prev = "";
  //       $('.search__btn').on('click',function(){
  //         var current = $('.search__text__input').val();
  //         if(current === prev) {
  //           // console.log('等しい');
  //           clickCount++;
  //         } else {
  //           // console.log('等しくない');
  //           clickCount = 1;
  //         }
  //         // console.log(current);
  //         // console.log(prev);
  //         prev = current;
  //         $.ajax({
  //           type: 'GET',
  //           url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
  //           dataType: 'json',//dataは間違い
  //           data:{
  //             applicationId: '1019399324990976605', 
  //             booksGenreId: '001',
  //             keyword: current,
  //             hits: 20,
  //             page: clickCount
  //           },
  //         }).done(function(json, status, xhr){
  //           // var prependArray = [];
  //           // prependArray = $('.lists__item');
  //           // console.log(prependArray);
  //           // prependArray.reverse();
  //           // console.log(json);
  //           if(clickCount === 1){
  //             $('.lists').empty();
  //             moveGet();
  //           // }else if(xhr.status === 429){
  //           //   $('.search').after(
  //           //     '<div class ="message">'+
  //           //     'リクエスト数が上限に達しました。'+'<br>'+
  //           //     'しばらく時間を空けてから、ご利用ください。'+'</div>');
  //           }else{
  //             moveGet();
  //           };// $('.lists').remove();// $('.lists').find('.lists__item__detail').remove(':conteins("prevWord")');// $('.lists__item__detail').remove(':conteins("prevWord")');間違い
  //           $('.message').remove();
  //           if(json.count == 0){
  //             alert();
  //           };
  // //---------------------------------------------------
  //           function moveGet(){
  //             movePrepend();
  //           };
  // //---------------------------------------------------
  // // function movePrepend(){
  // //             $('ul').prepend(//replaceWith : 置換//detach : 要素を削除//empty : 要素内を削除//append : 後ろに追加
  // //               // $('.lists').append(
  // //                 '<li class="lists__item">'+
  // //                 '<div class="lists__item__inner">'+
  // //                 '<a href="'+itemVal+'" class="lists__item__link" target="_blank">'+
  // //                 '<img src=" '+imageVal+' " class="lists__item__img" alt="'+titleVal+'">'+
  // //                 '<p class="lists__item__detail">作品名：'+titleVal+'</p>'+
  // //                 '<p class="lists__item__detail">作者　：'+authorVal+'</p>'+
  // //                 '<p class="lists__item__detail">出版社：'+publisherVal+'</p>'+
  // //                 '</a>'+
  // //                 '</div>'+
  // //                 '</li>'//)
  // //               );
  // //             // var $arr = $('li').sort(function(a, b){
  // //             //   return ($(a).text() > $(b).text() ? 1 : -1);
  // //             //   return ($(a).text() < $(b).text() ? -1 : 1);  //ソート条件
  // //             // });
  // //           };
  // //----------------------------------------------------
  //           function movePrepend(){
  //             // var list = '';
  //             var list = '';
  //             $.each(json.Items,function(i,val){
  //               itemVal = val.Item.itemUrl,
  //               imageVal = val.Item.largeImageUrl,
  //               titleVal = val.Item.title,
  //               authorVal = val.Item.author,
  //               publisherVal = val.Item.publisherName;
  //               // prependArray.reverse();
  //               console.log(list);
  //             });
  //             $('.lists').prepend(list);
  //           };
  // //----------------------------------------------------
  //           function alert(){
  //             $('.search').after('<div class ="message">'+
  //               '検索結果が見つかりませんでした。'+
  //               '<br>'+'別のキーワードで検索して下さい。'+
  //               '</div>'
  //             );
  //           };
  // //----------------------------------------------------
  //         }).fail(function(json){
  //           // console.log(json);
  //           $('.message').remove();
  //           console.log(json);
  //           $('.search').after('<div class ="message">'+json.responseJSON.error_description+'</div>');
  // //----------------------------------------------------
  //           // function alert2(){
  //           //   if(current == ""){
  //           //     $('.search').after(
  //           //       '<div class ="message">'+
  //           //       '検索結果が見つかりませんでした。'+'<br>'+
  //           //       'キーワードを入力して下さい。'+'</div>');
  //           //   }else if(1 <= clickCount <= 2){
  //           //     $('.search').after(
  //           //       '<div class ="message">'+
  //           //       '検索キーワードは半角2文字もしくは全角1文字以上、'+'<br>'+
  //           //       'ひらがな・カタカナ・記号の場合は2文字以上で指定して下さい。'+'</div>');
  //           //     // }else if(json.responseJSON){
  //           //     //   '<div class ="message">'+
  //           //     //   'リクエスト数が上限に達しました。'+'<br>'+
  //           //     //   'しばらく時間を空けてから、ご利用ください。'+'</div>');
  //           //   }else{
  //           //     $('.search').after(
  //           //       '<div class ="message">'+
  //           //       'データ通信できませんでした。'+'<br>'+
  //           //       '接続を確認してください。'+'</div>');
    </script>
  </body>
</html>
